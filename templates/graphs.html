{% extends "base.html" %}
{% block title %}Race Graph{% endblock %}
{% block head_bottom %}
    <link href="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.js"></script>
    <style>
        .dual-list-box {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .list-box {
            width: 250px;
            height: 200px;
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-links {
            margin-bottom: 20px;
        }

        .nav-links a {
            margin-right: 10px;
            text-decoration: none;
            color: #007bff;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .submit {
            margin-top: 10px; 
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .selected-count {
            margin-left: 480px;
            font-size: 14px;
            margin-bottom: 5px;
            color: #555;
        }
        .warning-box {
            margin-top: 50px;
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            color: #c62828;
            margin-bottom: 20px;
            display: inline-block; /* Hidden by default */
            max-width: 100%; /* Ensure it doesn't overflow the container */
            white-space: nowrap; /* Prevent text from wrapping */

        }
    </style>
{% endblock %}

{% block content %}
    <h1>Race {{ race_id }} Graph Generator</h1>

    <div class="nav-links">
        {% for race_id in race_ids %}
            <a href="{{ url_for('graphs.graphs', race_id=race_id) }}">Race {{ race_id }}</a>
        {% endfor %}
    </div>
    <div class="selected-count" id="selectedCount">Selected: 0/10</div>
    <form hx-post="{{ url_for('graphs.generate_graph_route', race_id=race_id) }}"
          hx-target="#graph-container"
          hx-swap="innerHTML">
        <div class="dual-list-box">
            <select id="availableAthletes" name="available_athletes" class="list-box" multiple>
                {% for athlete in athlete_ids %}
                    <option value="{{ athlete['BibNumber'] }}">
                        {{ athlete['FirstName'] }} {{ athlete['LastName'] }} ({{ athlete['BibNumber'] }})
                    </option>
                {% endfor %}
            </select>

            <select id="selectedAthletes" name="selected_athletes" class="list-box" multiple>
            </select>
        </div>
        <p class="instructions" style="font-size: 14px; color: #555; margin-top: 5px;">
            Double-click an athlete to select or deselect (maximum of 10 selections).
        </p>

        <button type="submit" class="submit">Generate Graph</button>
    </form>

    <div id="graph-container" style="width: 100%; height: auto; margin: 0 auto;">
        {% if div %}
            {{ div | safe }}
        {% endif %} 
    </div>

    {% if script %}
        {{ script | safe }}
    {% endif %}
    <script src="https://unpkg.com/htmx.org"></script>
    <script>
        function updateSelectedCount() {
            const selected = document.getElementById('selectedAthletes');
            const selectedCount = selected.options.length;
            const countText = `Selected: ${selectedCount}/10`;
            document.getElementById('selectedCount').textContent = countText;
        }
    
        function moveToSelected() {
            const available = document.getElementById('availableAthletes');
            const selected = document.getElementById('selectedAthletes');
            const selectedOptions = [...available.selectedOptions];
    
            // Limit to a maximum of 10 athletes
            let spaceLeft = 10 - selected.options.length;
            if (spaceLeft <= 0) return;
    
            // Move only up to the allowed limit
            selectedOptions.slice(0, spaceLeft).forEach(option => {
                selected.add(option);
            });
            updateSelectedCount();
        }
    
        function moveToAvailable() {
            const available = document.getElementById('availableAthletes');
            const selected = document.getElementById('selectedAthletes');
            const selectedOptions = [...selected.selectedOptions];
    
            selectedOptions.forEach(option => {
                available.add(option);
            });
            updateSelectedCount();
        }
    
        // Attach double-click event handlers to each list
        document.getElementById('availableAthletes').addEventListener('dblclick', moveToSelected);
        document.getElementById('selectedAthletes').addEventListener('dblclick', moveToAvailable);
    
        // Update selected count when selections change
        document.getElementById('availableAthletes').addEventListener('change', updateSelectedCount);
        document.getElementById('selectedAthletes').addEventListener('change', updateSelectedCount);
    
        // Before form submission, mark all options in the selected list as selected.
        document.querySelector('form').addEventListener('submit', function() {
            const selected = document.getElementById('selectedAthletes');
            for (let i = 0; i < selected.options.length; i++) {
                selected.options[i].selected = true;
            }
        });
    
        // Initialize the selected count on page load
        updateSelectedCount();
    </script>
{% endblock %}