{% extends "base.html" %}

{% block title %}Report Generator{% endblock %}

{% block content %}
<div style="margin: 20px;">
    <h1 style="margin-bottom: 16px;">Report Generator</h1>

    <!-- selectors -->
    <div>
        <div style="margin: 10px 0;">
            <label for="db-select">Choose a database:</label>
            <select id="db-select" class="down-arrow" onchange="updateQueryParams('db', this.value)">
                {% for db in db_names %}
                    <option value="{{ db.file }}" {% if db_file == db.file %}selected{% endif %}>{{ db.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin: 10px 0;">
            <label for="query-select">Choose a report:</label>
            <select id="query-select" class="down-arrow" onchange="updateQueryParams('query', this.value)">
                {% for report in report_names %}
                    <option value="{{ report.file }}" {% if query_file == report.file %}selected{% endif %}>{{ report.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if needed_parameters %}
        <div style="margin: 10px 0;" id="parameter-container">
            {% for param in needed_parameters %}
                {% if param == "race_id" %}
                    <div style="margin: 8px 0;">
                        <label for="race-select">Choose a race:</label>
                        <select id="race-select" class="down-arrow" onchange="updateQueryParams('{{ param }}', this.value)">
                            {% for race in races %}
                                <option value="{{ race['IDRace'] }}" {% if query_params.get(param) == race['IDRace'] %}selected{% endif %}>
                                    {{ race['RaceCity'] }} - {{ race['RaceDate'] }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% else %}
                    <div style="margin: 8px 0;">
                        <label for="{{ param }}">{{ param | capitalize }}:</label>
                        <input type="text" id="{{ param }}" name="{{ param }}" value="{{ query_params.get(param, "") }}"
                               onchange="updateQueryParams('{{ param }}', this.value)">
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if pdf_available %}
        <div style="margin: 16px 0;">
            <form action="{{ url_for('reports.download_pdf') }}" method="get">
                <input type="hidden" name="query" value="{{ query_file }}">
                <input type="hidden" name="db"    value="{{ db_file }}">
                {% for param, value in query_params.items() %}
                    <input type="hidden" name="{{ param }}" value="{{ value }}">
                {% endfor %}
                <button type="submit" class="mv10">Download PDF</button>
            </form>
        </div>
    {% endif %}

    <div id="table-container" style="margin: 16px 0;">
        {{ table | safe }}
    </div>
</div>

<script>
    function updateQueryParams(key, value) {
        const url = new URL(window.location.href);
        url.searchParams.set(key, value);
        window.location.href = url.toString();
    }
</script>
{% endblock %}
