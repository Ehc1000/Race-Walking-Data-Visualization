<div class="table-container" id="table-container-{{ table }}">
    <h2 style="display: flex; justify-content: space-between; align-items: center;">
        Table: {{ table }}
        <input type="text" name="search_term" placeholder="Search"
            value="{{ content.search_term }}"
            hx-get="{{ url_for('data.load_table', table=table) }}?page=1"
            hx-target="#table-container-{{ table }}"
            hx-swap="outerHTML"
            hx-include="[name='search_term']"
            hx-trigger="keyup[key=='Enter']"
            style="padding: 5px; font-size: 14px;" />
    </h2>
    <div class="table-scroll">
        <table border="1" id="{{ table }}">
            <thead>
                <tr>
                    <th>Actions</th>
                    {% for col in content.columns %}
                    <th>
                        <a href="#"
                            hx-get="{{ url_for('data.load_table', table=table) }}?sort={{ col }}&order={{ 'desc' if content.sort_by == col and content.order == 'asc' else 'asc' }}&page=1"
                            hx-include="[name='search_term']"
                            hx-swap="outerHTML"
                            hx-target="closest .table-container">
                            {{ col }}
                            {% if content.sort_by == col %}
                            {{ '▼' if content.order == 'desc' else '▲' }}
                            {% endif %}
                        </a>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in content.rows %}
                <tr>
                    <td>
                        <button hx-delete="{{ url_for('data.delete_row', table=table, pk=row[0]) }}"
                                hx-confirm="Are you sure you want to delete this row?"
                                hx-target="#table-container-{{ table }}"
                                hx-swap="outerHTML">
                            Delete
                        </button>
                        <button onclick="addEmptyRow(this)">Add Row</button>
                    </td>
                    {% for item in row %}
                    <td>
                        <div class="editable"
                            hx-target="closest td"
                            hx-patch="{{ url_for('data.update_cell', table=table, column=content.columns[loop.index0], pk=row[0]) }}"
                            contenteditable="true"
                            hx-trigger="edit-confirm"
                            hx-swap="outerHTML"
                            hx-include="next input[name='value']"
                            onfocus="storeOriginalValue(this)">
                            {{ item }}
                        </div>
                        <input type="hidden" name="value" value="{{ item }}" />
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        {% if content.current_page > 1 %}
        <a href="#"
            hx-get="{{ url_for('data.load_table', table=table) }}?page={{ content.current_page - 1 }}&sort={{ content.sort_by }}&order={{ content.order }}"
            hx-include="[name='search_term']"
            hx-target="#table-container-{{ table }}"
            hx-swap="outerHTML">Previous</a>
        {% endif %}

        <span>Page {{ content.current_page }} of {{ content.total_pages }}</span>

        {% if content.current_page < content.total_pages %}
        <a href="#"
            hx-get="{{ url_for('data.load_table', table=table) }}?page={{ content.current_page + 1 }}&sort={{ content.sort_by }}&order={{ content.order }}"
            hx-include="[name='search_term']"
            hx-target="#table-container-{{ table }}"
            hx-swap="outerHTML">Next</a>
        {% endif %}
    </div>
</div>

<script>
    function storeOriginalValue(element) {
        element.setAttribute('data-original-value', element.innerText);
    }

    function addEmptyRow(button) {
        const currentRow = button.closest("tr");
        const newRow = currentRow.cloneNode(true);
        const tds = newRow.querySelectorAll("td");
        tds.forEach((td, index) => {
            if (index === 0) return;
            const editableDiv = td.querySelector(".editable");
            const hiddenInput = td.querySelector("input[name='value']");
            editableDiv.innerText = "";
            hiddenInput.value = "";
        });
        currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
    }
</script>
